window.cue=window.cue||{},function(a,b,c,d,e,f){"use strict";var g;cue.data=_cueSettings,g=cue.data.l10n,c.extend(cue,{controller:{},model:{},view:{}}),e.media.view.settings.post.id=cue.data.settings.postId,e.media.view.settings.defaultProps={},d.plugins.silverlight[0].types.push("audio/x-ms-wma"),jQuery(function(a){var b;b=cue.tracks=new cue.model.Tracks(cue.data.tracks),delete cue.data.tracks,new cue.view.PostForm({collection:b})})}(this,jQuery,_,mejs,wp),window.cue=window.cue||{},function(a,b,c,d,e){"use strict";var f,g=d.media.model.Attachment,h=cue.data.l10n;f=cue.workflows={frames:[],model:{},setModel:function(a){return this.model=a,this},get:function(a){var b="_"+a,c=this.frames[b]||null;return c=this[b].call(this,c),this.frames[b]=c,c},_addTracks:function(a){return a?a:(a=new cue.view.MediaFrame({title:h.workflows.addTracks.frameTitle,library:{type:"audio"},button:{text:h.workflows.addTracks.frameButtonText},multiple:"add"}),a.uploader.options.uploader.plupload={filters:{mime_types:[{title:h.workflows.addTracks.fileTypes,extensions:"m4a,mp3,ogg,wma"}]}},a.state("embed").props.off("change:url",a.state("embed").debouncedScan),a.state("insert").on("insert",function(a){c.each(a.models,function(a){cue.tracks.push(a.toJSON().cue)})}),a.state("embed").on("select",function(){var a=this.props.toJSON(),b={audioId:"",audioUrl:a.url};"title"in a&&""!==a.title&&(b.title=a.title),cue.tracks.push(b)}),a)},_selectArtwork:function(a){var b=this;return a?a:(a=d.media({title:h.workflows.selectArtwork.frameTitle,library:{type:"image"},button:{text:h.workflows.selectArtwork.frameButtonText},multiple:!1}),a.uploader.options.uploader.plupload={filters:{mime_types:[{files:h.workflows.selectArtwork.fileTypes,extensions:"jpg,jpeg,gif,png"}]}},a.on("open",function(){var a=this.get("library").get("selection"),c=b.model.get("artworkId"),d=[];c&&(d.push(g.get(c)),d[0].fetch()),a.reset(d)}),a.state("library").on("select",function(){var a=this.get("selection").first().toJSON();b.model.set({artworkId:a.id,artworkUrl:a.sizes.cue.url})}),a)},_selectAudio:function(a){var b=this;return a?a:(a=new cue.view.MediaFrame({title:h.workflows.selectAudio.frameTitle,library:{type:"audio"},button:{text:h.workflows.selectAudio.frameButtonText},multiple:!1}),a.uploader.options.uploader.plupload={filters:{mime_types:[{title:h.workflows.selectAudio.fileTypes,extensions:"m4a,mp3,ogg,wma"}]}},a.state("embed").props.off("change:url",a.state("embed").debouncedScan),a.on("open",function(){var c=this.get("insert").get("selection"),d=b.model.get("audioId"),e=b.model.get("audioUrl"),f=e&&!d,h=[];d&&(h.push(g.get(d)),h[0].fetch()),c.reset(h),f?this.get("embed").props.set({url:e,title:b.model.get("title")}):this.get("embed").props.set({url:"",title:""}),a.setState(f?"embed":"insert")}),a.state("insert").on("insert",function(a){var d=a.first().toJSON().cue,e={},f=c.keys(b.model.attributes);c.without(f,["id","order"]),c.each(f,function(a){var c=b.model.get(a);!c&&a in d&&c!==d[a]&&(e[a]=d[a])}),e.audioId=d.audioId,e.audioUrl=d.audioUrl,b.model.set(e)}),a.state("embed").on("select",function(){var a=this.props.toJSON(),c={};c.audioId="",c.audioUrl=a.url,"title"in a&&""!==a.title&&(c.title=a.title),b.model.set(c)}),a.on("escape",function(){var a=f.model.toJSON();a.artworkUrl||a.audioUrl||f.model.destroy()}),a)}}}(this,jQuery,_,wp),window.cue=window.cue||{},function(a,b,c,d,e,f){"use strict";cue.model.Track=d.Model.extend({defaults:{artist:"",artworkId:"",artworkUrl:"",audioId:"",audioUrl:"",format:"",length:"",title:"",order:0}}),cue.model.Tracks=d.Collection.extend({model:cue.model.Track,comparator:function(a){return parseInt(a.get("order"),10)},fetch:function(){var a=this;return e.ajax.post("cue_get_playlist",{post_id:cue.data.settings.postId}).done(function(b){a.reset(b)})},save:function(a){return this.sort(),a=c.extend({},a,{post_id:cue.data.settings.postId,tracks:this.toJSON(),nonce:cue.data.settings.saveNonce}),e.ajax.post("cue_save_playlist_tracks",a)}})}(this,jQuery,_,Backbone,wp),window.cue=window.cue||{},function(a,b,c,d,e,f){"use strict";var g,h=cue.data.l10n;g=cue.workflows=cue.workflows||{},cue.view.MediaFrame=e.media.view.MediaFrame.Post.extend({createStates:function(){var a=this.options;this.states.add([new e.media.controller.Library({id:"insert",title:this.options.title,priority:20,toolbar:"main-insert",filterable:"uploaded",library:e.media.query(a.library),multiple:a.multiple?"reset":!1,editable:!1,allowLocalEdits:!0,displaySettings:!1,displayUserSettings:!1}),new e.media.controller.Embed({title:h.addFromUrl,menuItem:{text:h.addFromUrl,priority:120},type:"link"})])},bindHandlers:function(){e.media.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("toolbar:create:main-insert",this.createToolbar,this),this.on("toolbar:create:main-embed",this.mainEmbedToolbar,this);var a={menu:{"default":"mainMenu"},content:{embed:"embedContent","edit-selection":"editSelectionContent"},toolbar:{"main-insert":"mainInsertToolbar"}};c.each(a,function(a,b){c.each(a,function(a,c){this.on(b+":render:"+c,this[a],this)},this)},this)},mainInsertToolbar:function(a){var b=this;this.selectionStatusToolbar(a),a.set("insert",{style:"primary",priority:80,text:b.options.button.text,requires:{selection:!0},click:function(){var a=b.state(),c=a.get("selection");b.close(),a.trigger("insert",c).reset()}})},mainEmbedToolbar:function(a){a.view=new e.media.view.Toolbar.Embed({controller:this,text:this.options.button.text})}}),cue.view.PostForm=e.Backbone.View.extend({el:"#post",saved:!1,events:{"click #publish":"buttonClick","click #save-post":"buttonClick"},initialize:function(){this.render()},render:function(){return this.views.add("#cue-section",[new cue.view.AddTracksButton({collection:this.collection}),new cue.view.TrackList({collection:this.collection})]),this},buttonClick:function(a){var c=this,d=b(a.target);d.siblings(".spinner");return c.saved||this.collection.save().done(function(a){c.saved=!0,d.click()}).fail(function(){}),c.saved}}),cue.view.AddTracksButton=e.Backbone.View.extend({id:"add-tracks",tagName:"p",events:{"click .button":"click"},render:function(){var a=b("<a />",{text:h.addTracks}).addClass("button button-secondary");return this.$el.html(a),this},click:function(a){a.preventDefault(),g.get("addTracks").open()}}),cue.view.TrackList=e.Backbone.View.extend({className:"cue-tracklist",tagName:"ol",initialize:function(){this.listenTo(this.collection,"add",this.addTrack),this.listenTo(this.collection,"add remove",this.updateOrder),this.listenTo(this.collection,"reset",this.render),this.render().$el.sortable({axis:"y",delay:150,forceHelperSize:!0,forcePlaceholderSize:!0,opacity:.6,start:function(a,b){b.placeholder.css("visibility","visible")},update:c.bind(function(a,b){this.updateOrder()},this)})},render:function(){return this.$el.empty(),this.collection.each(this.addTrack,this),this.updateOrder(),this},addTrack:function(a){var b=new cue.view.Track({model:a});this.$el.append(b.render().el)},updateOrder:function(){c.each(this.$el.find(".cue-track"),function(a,c){var d=b(a).data("cid");this.collection.get(d).set("order",c)},this)}}),cue.view.Track=e.Backbone.View.extend({tagName:"li",className:"cue-track",template:e.template("cue-playlist-track"),events:{"change [data-setting]":"updateAttribute","click .js-toggle":"toggleOpenStatus","dblclick .cue-track-title":"toggleOpenStatus","click .js-close":"minimize","click .js-remove":"destroy"},initialize:function(){this.listenTo(this.model,"change:title",this.updateTitle),this.listenTo(this.model,"change",this.updateFields),this.listenTo(this.model,"destroy",this.remove)},render:function(){return this.$el.html(this.template(this.model.toJSON())).data("cid",this.model.cid),this.views.add(".cue-track-column-artwork",new cue.view.TrackArtwork({model:this.model,parent:this})),this.views.add(".cue-track-audio-group",new cue.view.TrackAudio({model:this.model,parent:this})),this},minimize:function(a){a.preventDefault(),this.$el.removeClass("is-open").find("input:focus").blur()},toggleOpenStatus:function(c){c.preventDefault(),this.$el.toggleClass("is-open").find("input:focus").blur(),this.$el.hasClass("is-open")&&b(a).trigger("resize")},updateAttribute:function(a){var c=b(a.target).data("setting"),d=a.target.value;this.model.get(c)!==d&&this.model.set(c,d)},updateFields:function(){var a,c,d=this.model.toJSON(),e=this.$el.find("[data-setting]");for(a in d)c=b("<div/>").html(d[a]).text(),e.filter('[data-setting="'+a+'"]').val(c)},updateTitle:function(){var a=this.model.get("title");this.$el.find(".cue-track-title .text").text(a?a:"Title")},destroy:function(){this.model.trigger("destroy",this.model)},remove:function(){this.$el.remove()}}),cue.view.TrackArtwork=e.Backbone.View.extend({tagName:"span",className:"cue-track-artwork",template:e.template("cue-playlist-track-artwork"),events:{click:"select"},initialize:function(a){this.parent=a.parent,this.listenTo(this.model,"change:artworkUrl",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.parent.$el.toggleClass("has-artwork",!c.isEmpty(this.model.get("artworkUrl"))),this},select:function(){g.setModel(this.model).get("selectArtwork").open()}}),cue.view.TrackAudio=e.Backbone.View.extend({tagName:"span",className:"cue-track-audio",template:e.template("cue-playlist-track-audio"),events:{"click .cue-track-audio-selector":"select"},initialize:function(a){this.parent=a.parent,this.listenTo(this.model,"change:audioUrl",this.refresh),this.listenTo(this.model,"destroy",this.cleanup)},render:function(){var a,e,f=this.model.toJSON(),g=this.$el.find(".mejs-audio").attr("id");return""===f.audioUrl&&g&&d.players[g].remove(),this.$el.html(this.template(this.model.toJSON())),a=this.$el.find(".cue-audio"),a.length&&(a.wrap("<body></body>"),e={features:["playpause","current","progress","duration"],pluginPath:cue.data.settings.pluginPath,success:c.bind(function(a,c,d){var e=b(d.container).parent();d.current.removeClass("mejs-time-current").addClass("cuemejs-time-current wp-ui-highlight"),b.nodeName(e.get(0),"body")&&e.replaceWith(e.get(0).childNodes)},this),error:function(a){var c=b(a),e=c.closest(".cue-track"),f=c.closest(".mejs-audio").attr("id");d.players[f].remove(),e.find("audio").remove()}},"m4a"===a.attr("src").split(".").pop()&&(e.pluginVars="isvideo=true"),a.mediaelementplayer(e)),this},refresh:function(a){var b=this.model.toJSON(),c=this.$el.find(".mejs-audio").attr(" id"),e=c?d.players[c]:null;e&&""!==b.audioUrl?(e.pause(),e.setSrc(b.audioUrl)):this.render()},cleanup:function(){var a=(this.model.toJSON(),this.$el.find(".mejs-audio").attr("id")),b=a?d.players[a]:null;b&&b.remove()},select:function(){g.setModel(this.model).get("selectAudio").open()}})}(this,jQuery,_,mejs,wp);